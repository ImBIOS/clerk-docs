---
title: Build a custom flow for handling email links
description: Learn how to build a custom flow using Clerk's API to handle email links for sign-up, sign-in, and email address verification.
---

<Include src="_partials/custom-flows-callout" />

[Email links](/docs/authentication/configuration/sign-up-sign-in-options#email-link) can be used to sign up new users, sign in existing ones, or allow existing users to verify newly entered email addresses to user profiles.

The email link flow works as follows:

1. The user enters their email address and asks for an email link.
1. Clerk sends an email to the user, containing a link to the verification URL.
1. The user visits the email link, either on the same device where they entered their email address or on a different device.
1. Clerk verifies the user's identity and advances any sign-up or sign-in attempt that might be in progress.
1. If the verification is successful, the user is authenticated or their email address is verified, depending on the reason for the email link.

This guide demonstrates how to use Clerk's API to build a custom flow for handling email links. It covers the following scenarios:

- [Sign up](#sign-up-flow)
- [Sign in](#sign-in-flow)
- [Verify a new email address](#email-address-verification-flow)

{/* TODO: Update these Steps when the Steps component can accept other headings. As of right now, Steps can only accept H3s. */}

<Steps>
  ### Enable email link authentication

  To allow your users to sign up or sign in using email links, you must first configure the appropriate settings in the Clerk Dashboard.

  1. In the Clerk Dashboard, navigate to the [**Email, phone, username**](https://dashboard.clerk.com/last-active?path=user-authentication/email-phone-username) page.
  1. In the **Contact information** section, **Email address** should be enabled and required.
  1. In the **Username** section, ensure that **Username** is not required. If you want to require a username, you must collect it and pass it to the `create()` method (you'll see how it's used later in the code examples).
  1. In the **Authentication strategies** section, ensure **only** **Email verification link** is enabled.
  1. Keep this page open to enable email link verification in the next step.

  ### Enable email link verification

  [**Verification methods**](/docs/authentication/configuration/sign-up-sign-in-options#verification-methods) are different from [**authentication strategies**](/docs/authentication/configuration/sign-up-sign-in-options#authentication-strategies). **Authentication strategies** are used for authenticating a user, such as when they are signing in to your application. **Verification methods** are used for verifying a user's identifier, such as an email address upon initial sign-up or when updating their profile.

  To allow your users to verify their email addresses using email links, configure the following settings:

  1. On the [**Email, phone, username**](https://dashboard.clerk.com/last-active?path=user-authentication/email-phone-username) page of the Clerk Dashboard, next to **Email address**, select the settings icon. A modal will open.
  1. Under **Verification methods**, enable the **Email verification link** option. You can leave **Require the same device and browser** enabled, or disable it if you want to allow users to verify their email addresses on different devices. The code examples will show how to handle either option. Because this guide focuses on email links, uncheck the box for **Email verification code**.
  1. Select **Continue** to save your changes.

  ### Create the flows

  The flow for handling email links is the same across all use cases. You must:

  1. Initiate the sign-up, sign-in, or email verification process by collecting the user's email address.
  1. Prepare the email address verification, which sends an email link to the given address.
  1. Handle the email link verification result accordingly.
     - If the email address verification is successful, set the newly created session as the active session.
     - If the verification failed or the email link has expired, inform the user.

  ### Sign-up flow

  In the following example, the user is prompted to enter their email address and then click a button to sign up using an email link. The user is then redirected to a verification page where they can see the result of the email link verification.

  <Tabs items={["Next.js"]}>
    <Tab>
      <CodeBlockTabs options={["/sign-up/page.tsx", "/sign-up/verify/page.tsx"]}>
        ```tsx {{ filename: '/sign-up/page.tsx' }}
        'use client'

        import * as React from 'react'
        import { useSignUp } from '@clerk/nextjs'

        export default function SignInPage() {
          const [emailAddress, setEmailAddress] = React.useState('')
          const [verified, setVerified] = React.useState(false)
          const [verifying, setVerifying] = React.useState(false)
          const { signUp, isLoaded } = useSignUp()

          if (!isLoaded) {
            return null
          }

          const { startEmailLinkFlow } = signUp.createEmailLinkFlow()

          async function submit(e: React.FormEvent) {
            e.preventDefault()
            // Reset states in case user resubmits form mid sign-up
            setVerified(false)
            setVerifying(true)

            if (!isLoaded && !signUp) return null

            // Start the sign-up process using the email provided
            try {
              await signUp.create({
                emailAddress,
              })

              // Dynamically set the host domain for dev and prod
              // You could instead use an environment variable or other source for the host domain
              const protocol = window.location.protocol
              const host = window.location.host

              // Send the user an email with the email link
              const signUpAttempt = await startEmailLinkFlow({
                // URL to navigate to after the user visits the link in their email
                redirectUrl: `${protocol}//${host}/sign-up/verify`,
              })

              // Check the verification result
              const verification = signUpAttempt.verifications.emailAddress

              // Handle if user visited the link and completed sign-up from /sign-up/verify
              if (verification.verifiedFromTheSameClient()) {
                setVerifying(false)
                setVerified(true)
                return
              }
            } catch (err: any) {
              // See https://clerk.com/docs/custom-flows/error-handling
              // for more info on error handling
              console.error(JSON.stringify(err, null, 2))
            }
          }

          async function reset(e: React.FormEvent) {
            e.preventDefault()
            setVerifying(false)
          }

          if (verifying) {
            return (
              <div>
                <p>Check your email and visit the link that was sent to you.</p>
                <form onSubmit={reset}>
                  <button type="submit">Restart</button>
                </form>
              </div>
            )
          }

          if (verified) {
            return <div>Signed up successfully!</div>
          }

          return (
            <div>
              <h1>Sign up</h1>
              <form onSubmit={submit}>
                <input
                  type="email"
                  value={emailAddress}
                  onChange={(e) => setEmailAddress(e.target.value)}
                />
                <button type="submit">Continue</button>
              </form>
            </div>
          )
        }
        ```

        ```tsx {{ filename: '/sign-up/verify/page.tsx' }}
        'use client'

        import * as React from 'react'
        import { useClerk } from '@clerk/nextjs'
        import { EmailLinkErrorCode, isEmailLinkError } from '@clerk/nextjs/errors'
        import Link from 'next/link'
        // TODO: Use once @clerk/types is updated
        //import { VerificationStatus } from '@clerk/types';

        // TODO: Remove once @clerk/types is updated
        export type VerificationStatus =
          | 'expired'
          | 'failed'
          | 'loading'
          | 'verified'
          | 'verified_switch_tab'
          | 'client_mismatch'

        export default function VerifyEmailLink() {
          const [verificationStatus, setVerificationStatus] = React.useState('loading')

          const { handleEmailLinkVerification } = useClerk()

          async function verify() {
            try {
              // Dynamically set the host domain for dev and prod
              // You could instead use an environment variable or other source for the host domain
              const protocol = window.location.protocol
              const host = window.location.host

              await handleEmailLinkVerification({
                // URL to navigate to if sign-in flow needs more requirements
                redirectUrl: `${protocol}//${host}/sign-in`,
                // URL to navigate to if sign-in flow is complete
                redirectUrlComplete: `${protocol}//${host}/sign-in/verify`,
              })
              // If not redirected at this point,
              // the flow has completed (email was verified) on another device.
              setVerificationStatus('verified')
            } catch (err: any) {
              // Set status to failed
              let status: VerificationStatus = 'failed'

              // If link expired, set status to expired
              if (isEmailLinkError(err) && err.code === EmailLinkErrorCode.Expired) {
                status = 'expired'
              }

              // OPTIONAL: This check is only required if you have
              // the 'Require the same device and browser' setting
              // enabled in the Clerk Dashboard
              if (isEmailLinkError(err) && err.code === EmailLinkErrorCode.ClientMismatch) {
                status = 'client_mismatch'
              }

              setVerificationStatus(status)
            }
          }

          React.useEffect(() => {
            verify()
          }, [handleEmailLinkVerification])

          if (verificationStatus === 'loading') {
            return <div>Loading...</div>
          }

          if (verificationStatus === 'failed') {
            return (
              <div>
                <h1>Verify your email</h1>
                <p>The email link verification failed.</p>
                <Link href="/sign-up">Sign up</Link>
              </div>
            )
          }

          if (verificationStatus === 'expired') {
            return (
              <div>
                <h1>Verify your email</h1>
                <p>The email link has expired.</p>
                <Link href="/sign-up">Sign up</Link>
              </div>
            )
          }

          // OPTIONAL: This check is only required if you have
          // the 'Require the same device and browser' setting
          // enabled in the Clerk Dashboard
          if (verificationStatus === 'client_mismatch') {
            return (
              <div>
                <h1>Verify your email</h1>
                <p>
                  You must complete the email link sign-up on the same device and browser that you started
                  it on.
                </p>
                <Link href="/sign-up">Sign up</Link>
              </div>
            )
          }

          return <div>Successfully signed up. Return to the original tab to continue.</div>
        }
        ```
      </CodeBlockTabs>
    </Tab>
  </Tabs>

  ### Sign-in flow

  In the following example, the user is prompted to enter their email address and then click a button to sign in using an email link. The user is then redirected to a verification page where they can see the result of the email link verification.

  <Tabs items={["Next.js"]}>
    <Tab>
      <CodeBlockTabs options={["/sign-in/page.tsx", "/sign-in/verify/page.tsx"]}>
        ```tsx {{ filename: '/sign-in/page.tsx' }}
        'use client'

        import * as React from 'react'
        import { useSignIn } from '@clerk/nextjs'
        import { EmailLinkFactor, SignInFirstFactor } from '@clerk/types'

        export default function SignInPage() {
          const [emailAddress, setEmailAddress] = React.useState('')
          const [verified, setVerified] = React.useState(false)
          const [verifying, setVerifying] = React.useState(false)
          const { signIn, isLoaded } = useSignIn()

          if (!isLoaded) {
            return null
          }

          const { startEmailLinkFlow } = signIn.createEmailLinkFlow()

          async function submit(e: React.FormEvent) {
            e.preventDefault()
            // reset verified and expired state in case user resubmits form mid sign-in
            setVerified(false)
            setVerifying(true)

            if (!isLoaded && !signIn) return null

            try {
              // when the user submits the form with their email, start the in flow by creating a singIn object
              const { supportedFirstFactors } = await signIn.create({
                identifier: emailAddress,
              })

              // Filter the returned array to find the 'phone_code' entry
              const isEmailCodeFactor = (factor: SignInFirstFactor): factor is EmailLinkFactor => {
                return factor.strategy === 'email_link'
              }
              const emailLinkFactor = supportedFirstFactors?.find(isEmailCodeFactor)

              // @ts-ignore
              // TODO: Fix TS error
              const { emailAddressId } = emailLinkFactor

              // You can use window.location.host to dynamically set the host domain for dev and prod
              // You could optionally use an environment variable or other source for the host domain
              const protocol = window.location.protocol
              const host = window.location.host

              // Attempt the first factor verification by sending an email with an email link to the user
              // TODO: Alexis -- the path should just be /sign-in for this component and /sign-in/verify for the url two lines down
              const res = await startEmailLinkFlow({
                emailAddressId,
                redirectUrl: `${protocol}//${host}/custom-flows/sign-in/magic-link/verify`,
              })

              // Check the verification result.
              const verification = res.firstFactorVerification

              // if the user has clicked on the link and completed sign in from /sign-in/verify this will return true
              if (verification.verifiedFromTheSameClient()) {
                // set 'verified' true to display a success message or redirect the user
                setVerifying(false)
                setVerified(true)
                return
              }
            } catch (err: any) {
              // TODO: Alexis -- swap out this for the standard 'error handling' from docs
              console.error('error', err.errors[0].longMessage)
            }
          }

          async function reset(e: React.FormEvent) {
            e.preventDefault()
            setVerifying(false)
          }

          if (verifying) {
            return (
              <div>
                <p>Please check your email and click on the link that was sent to you</p>
                <form onSubmit={reset}>
                  <button type="submit">Restart</button>
                </form>
              </div>
            )
          }

          if (verified) {
            // Repalce this with your own success message or a redirect to another page as desired
            return <div>Signed in on other tab</div>
          }

          return (
            <div>
              <form onSubmit={submit}>
                <input
                  type="email"
                  value={emailAddress}
                  onChange={(e) => setEmailAddress(e.target.value)}
                />
                <button type="submit">Sign in with magic link</button>
              </form>
            </div>
          )
        }
        ```

        ```tsx {{ filename: '/sign-in/verify/page.tsx' }}
        'use client'

        import * as React from 'react'
        import { useClerk } from '@clerk/nextjs'
        import { EmailLinkErrorCode, isEmailLinkError } from '@clerk/nextjs/errors'
        import Link from 'next/link'
        // This can be used once @clerk/types is updated
        //import { VerificationStatus } from '@clerk/types';

        export type VerificationStatus =
          | 'expired'
          | 'failed'
          | 'loading'
          | 'verified'
          | 'verified_switch_tab'
          | 'client_mismatch'

        // verify the link when the user clicks on the link in their email
        export default function VerifyEmailLink() {
          const [verificationStatus, setVerificationStatus] = React.useState('loading')

          const { handleEmailLinkVerification } = useClerk()

          async function verify() {
            try {
              // You can use window.location.host to dynamically set the host domain for dev and prod
              // You could optionally use an environment variable or other source for the host domain
              const protocol = window.location.protocol
              const host = window.location.host

              await handleEmailLinkVerification({
                // URL to navigate to if the sign-in flow needs more requirements (name, username for sign-up) or MFA/second-factor (for sign-in)
                redirectUrl: `${protocol}//${host}/sign-in`,
                // What do to when successful
                redirectUrlComplete: `${protocol}//${host}/sign-in/verify`,
              })
              // If we're not redirected at this point, it means
              // that the flow has completed on another device.
              setVerificationStatus('verified')
            } catch (err: any) {
              // Verification has failed.
              let status: VerificationStatus = 'failed'
              if (isEmailLinkError(err) && err.code === EmailLinkErrorCode.Expired) {
                status = 'expired'
              }
              // This is only required if you have enabled 'Require the same device and browser' in Dashboard -> Auth -> Email, phone, username -> Email verification link settings -> 'Require the same device and brwoser'
              if (isEmailLinkError(err) && err.code === EmailLinkErrorCode.ClientMismatch) {
                status = 'client_mismatch'
              }
              setVerificationStatus(status)
            }
          }

          React.useEffect(() => {
            verify()
          }, [handleEmailLinkVerification])

          if (verificationStatus === 'loading') {
            return <div>Loading...</div>
          }

          if (verificationStatus === 'failed') {
            return (
              <div>
                <p>Magic link verification failed</p>
                <Link href="/sign-in">Sign In</Link>
              </div>
            )
          }

          if (verificationStatus === 'expired') {
            return (
              <div>
                <p>Magic link expired</p>
                <Link href="/sign-in">Sign In</Link>
              </div>
            )
          }

          // TODO: Alexis -- you may not to mention this is also optional, as per above comment
          if (verificationStatus === 'client_mismatch') {
            return (
              <div>
                <p>
                  You must complete the Email Link sign-in on the same device and browser as you started it
                  on
                </p>
                <Link href="/sign-in">Sign In</Link>
              </div>
            )
          }

          return <div>Successfully signed in. Return to the original tab to continue.</div>
        }
        ```
      </CodeBlockTabs>
    </Tab>
  </Tabs>

  ### Email address verification flow

  In the following example, the user is prompted to enter their email address and then click a button to verify their email address using an email link. The user is then redirected to a verification page where they can see the result of the email link verification.

  {/* <Tabs items={["Next.js"]}>
          <Tab>
            ```tsx
            ```
          </Tab>
        </Tabs> */}
</Steps>
